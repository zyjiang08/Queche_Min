# quiche_conn_timeout_as_nanos å¿«é€Ÿå‚è€ƒ

## ğŸ“Œ ä¸€å¥è¯æ€»ç»“

**è¿”å›è·ç¦»ä¸‹æ¬¡è¶…æ—¶çš„çº³ç§’æ•°ï¼Œå¦‚æœæ˜¯ UINT64_MAX åˆ™æ— éœ€å®šæ—¶å™¨ã€‚**

---

## ğŸ¯ ä¸‰ç§è¿”å›å€¼

```c
uint64_t timeout = quiche_conn_timeout_as_nanos(conn);
```

| å€¼ | å«ä¹‰ | ä½ åº”è¯¥åšä»€ä¹ˆ |
|---|---|---|
| `0` | å·²è¶…æ—¶ | ç«‹å³è°ƒç”¨ `quiche_conn_on_timeout(conn)` |
| `1 ~ 18446744073709551614` | å‰©ä½™çº³ç§’æ•° | è®¾ç½®å®šæ—¶å™¨ï¼Œåˆ°æœŸåè°ƒç”¨ `on_timeout()` |
| `18446744073709551615`<br>(UINT64_MAX) | æ— éœ€å®šæ—¶å™¨ | åœæ­¢/ç¦ç”¨å®šæ—¶å™¨ï¼ˆè¿æ¥å·²å…³é—­ï¼‰ |

---

## âš¡ å¿«é€Ÿä»£ç æ¨¡æ¿

### libev æ¨¡æ¿ï¼ˆæ¨èï¼‰

```c
// å‘é€æ•°æ®åè®¾ç½®è¶…æ—¶
static void flush_egress(struct ev_loop *loop, struct conn_io *conn_io) {
    // ... å‘é€æ•°æ®åŒ…ä»£ç  ...

    uint64_t timeout_ns = quiche_conn_timeout_as_nanos(conn_io->conn);

    if (timeout_ns != UINT64_MAX) {
        double timeout_sec = timeout_ns / 1e9;
        conn_io->timer.repeat = timeout_sec;
        ev_timer_again(loop, &conn_io->timer);
    } else {
        ev_timer_stop(loop, &conn_io->timer);
    }
}

// è¶…æ—¶å›è°ƒ
static void timeout_cb(EV_P_ ev_timer *w, int revents) {
    struct conn_io *conn_io = w->data;
    quiche_conn_on_timeout(conn_io->conn);
    flush_egress(loop, conn_io);
}
```

### select/poll æ¨¡æ¿

```c
uint64_t timeout_ns = quiche_conn_timeout_as_nanos(conn);
struct timeval tv, *tv_ptr = NULL;

if (timeout_ns != UINT64_MAX) {
    tv.tv_sec = timeout_ns / 1000000000;
    tv.tv_usec = (timeout_ns % 1000000000) / 1000;
    tv_ptr = &tv;
}

int ret = select(fd + 1, &readfds, NULL, NULL, tv_ptr);
if (ret == 0) {
    quiche_conn_on_timeout(conn);  // è¶…æ—¶å¤„ç†
}
```

---

## âš ï¸ å¸¸è§é”™è¯¯

### âŒ é”™è¯¯ 1ï¼šå¿˜è®°æ£€æŸ¥ UINT64_MAX

```c
// é”™è¯¯ï¼å¦‚æœè¿”å› UINT64_MAX ä¼šè®¾ç½®è¶…é•¿å®šæ—¶å™¨
double timeout = quiche_conn_timeout_as_nanos(conn) / 1e9;
set_timer(timeout);
```

### âœ… æ­£ç¡®åšæ³•

```c
uint64_t t = quiche_conn_timeout_as_nanos(conn);
if (t != UINT64_MAX) {
    double timeout = t / 1e9;
    set_timer(timeout);
}
```

---

### âŒ é”™è¯¯ 2ï¼šè¶…æ—¶åä¸è°ƒç”¨ on_timeout()

```c
// é”™è¯¯ï¼è¶…æ—¶åå¿…é¡»è°ƒç”¨ on_timeout()
if (timeout_expired) {
    // ä»€ä¹ˆéƒ½ä¸åš - è¿æ¥ä¼šå¡æ­»ï¼
}
```

### âœ… æ­£ç¡®åšæ³•

```c
if (timeout_expired) {
    quiche_conn_on_timeout(conn);  // å¿…é¡»è°ƒç”¨ï¼
}
```

---

## ğŸ”„ å•ä½è½¬æ¢é€ŸæŸ¥è¡¨

| ä»çº³ç§’è½¬æ¢åˆ° | å…¬å¼ | ç¤ºä¾‹ï¼ˆ5ç§’ï¼‰ |
|------------|------|-----------|
| **ç§’** | `ns / 1e9` | `5000000000 / 1e9 = 5.0` |
| **æ¯«ç§’** | `ns / 1000000` | `5000000000 / 1000000 = 5000` |
| **å¾®ç§’** | `ns / 1000` | `5000000000 / 1000 = 5000000` |

```c
uint64_t ns = quiche_conn_timeout_as_nanos(conn);

double sec = ns / 1e9;          // ç§’ï¼ˆæµ®ç‚¹ï¼‰
uint64_t ms = ns / 1000000;     // æ¯«ç§’ï¼ˆæ•´æ•°ï¼‰
uint64_t us = ns / 1000;        // å¾®ç§’ï¼ˆæ•´æ•°ï¼‰
```

---

## ğŸ“Š è¿”å›å€¼ç¤ºä¾‹

| åœºæ™¯ | è¿”å›å€¼ (ns) | äººç±»å¯è¯» |
|------|-----------|---------|
| æ¡æ‰‹é˜¶æ®µ | 200000000 | 200 æ¯«ç§’ |
| ç¨³å®šä¼ è¾“ | 5000000000 | 5 ç§’ |
| å·²è¶…æ—¶ | 0 | ç«‹å³å¤„ç† |
| è¿æ¥å…³é—­ | 18446744073709551615 | æ— å®šæ—¶å™¨ |

---

## ğŸ” æ ‡å‡†ä½¿ç”¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å‘é€/æ¥æ”¶æ•°æ®                         â”‚
â”‚     quiche_conn_send() / recv()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. è·å–è¶…æ—¶å€¼                           â”‚
â”‚     timeout = timeout_as_nanos(conn)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚  æ£€æŸ¥è¿”å›å€¼   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                   â”‚
   [UINT64_MAX]        [æœ‰æ•ˆå€¼]
      â”‚                   â”‚
      â†“                   â†“
  åœæ­¢å®šæ—¶å™¨          è®¾ç½®å®šæ—¶å™¨
      â”‚                   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ç­‰å¾…äº‹ä»¶     â”‚
         â”‚ (ç½‘ç»œ/è¶…æ—¶)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚             â”‚
      [ç½‘ç»œ]         [è¶…æ—¶]
         â”‚             â”‚
         â†“             â†“
      æ¥æ”¶æ•°æ®    on_timeout()
         â”‚             â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â†“
         å›åˆ°æ­¥éª¤ 1
```

---

## ğŸ“ è°ƒè¯•æ£€æŸ¥æ¸…å•

è°ƒè¯•è¶…æ—¶é—®é¢˜æ—¶ï¼Œä¾æ¬¡æ£€æŸ¥ï¼š

- [ ] æ˜¯å¦æ£€æŸ¥äº† `UINT64_MAX`ï¼Ÿ
- [ ] è¶…æ—¶åæ˜¯å¦è°ƒç”¨äº† `quiche_conn_on_timeout()`ï¼Ÿ
- [ ] å•ä½è½¬æ¢æ˜¯å¦æ­£ç¡®ï¼ˆçº³ç§’ â†’ ç§’/æ¯«ç§’ï¼‰ï¼Ÿ
- [ ] å®šæ—¶å™¨ç²¾åº¦æ˜¯å¦è¶³å¤Ÿï¼ˆé¿å… `int` æˆªæ–­ï¼‰ï¼Ÿ
- [ ] æ˜¯å¦åœ¨æ¯æ¬¡ `send()/recv()` åæ›´æ–°è¶…æ—¶ï¼Ÿ
- [ ] è¶…æ—¶å€¼ä¸º 0 æ—¶æ˜¯å¦ç«‹å³å¤„ç†ï¼Ÿ

---

## ğŸ’» å®Œæ•´æœ€å°ç¤ºä¾‹

```c
#include <stdio.h>
#include <stdint.h>
#include <quiche.h>

#define UINT64_MAX 18446744073709551615ULL

void handle_timeout(quiche_conn *conn) {
    uint64_t timeout_ns = quiche_conn_timeout_as_nanos(conn);

    // ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥è¿”å›å€¼
    if (timeout_ns == UINT64_MAX) {
        printf("No timer needed\n");
        return;
    }

    // ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æ˜¯å¦å·²è¶…æ—¶
    if (timeout_ns == 0) {
        printf("Timeout expired! Handling now...\n");
        quiche_conn_on_timeout(conn);
        return;
    }

    // ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®å®šæ—¶å™¨
    double timeout_sec = timeout_ns / 1e9;
    printf("Setting timer for %.3f seconds\n", timeout_sec);
    // ä½ çš„å®šæ—¶å™¨è®¾ç½®ä»£ç ...
}
```

---

## ğŸ“– æ›´å¤šä¿¡æ¯

è¯¦ç»†åˆ†æè¯·æŸ¥çœ‹ï¼š**[TIMEOUT_AS_NANOS_ANALYSIS.md](TIMEOUT_AS_NANOS_ANALYSIS.md)**

åŒ…å«å†…å®¹ï¼š
- æºç è¯¦ç»†åˆ†æ
- å¤šç§äº‹ä»¶å¾ªç¯é›†æˆç¤ºä¾‹
- å¸¸è§é™·é˜±å’Œæœ€ä½³å®è·µ
- æµ‹è¯•å’ŒéªŒè¯æ–¹æ³•

---

**ç‰ˆæœ¬ï¼š** quiche 0.24.6
**æœ€åæ›´æ–°ï¼š** 2025-11-05
