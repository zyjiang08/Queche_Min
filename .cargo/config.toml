# Cargo configuration for optimized quiche builds
# Android-specific optimizations applied

# =============================================================================
# ANDROID ARM64 OPTIMIZATION (Most Common)
# =============================================================================

[target.aarch64-linux-android]
rustflags = [
    # Size optimization
    "-C", "opt-level=z",
    # Note: LTO removed due to incompatibility with rlib builds (cargo-ndk builds all crate types)
    "-C", "codegen-units=1",
    "-C", "panic=abort",

    # Remove unused sections
    "-C", "link-arg=-Wl,--gc-sections",

    # Strip all symbols
    "-C", "link-arg=-Wl,--strip-all",

    # Use hash-style for smaller size
    "-C", "link-arg=-Wl,--hash-style=gnu",

    # Merge identical code (ICF - Identical Code Folding)
    "-C", "link-arg=-Wl,--icf=all",

    # Discard local symbols
    "-C", "link-arg=-Wl,--discard-locals",

    # Hide symbols from static libraries (BoringSSL)
    "-C", "link-arg=-Wl,--exclude-libs,ALL",

    # Use version script for symbol visibility (if exists)
    # "-C", "link-arg=-Wl,--version-script=quiche/version.script",

    # Optimize for Cortex-A53 (common in Android devices)
    # Change to cortex-a55, cortex-a76 for newer devices
    "-C", "target-cpu=cortex-a53",

    # Enable NEON and crypto extensions
    "-C", "target-feature=+neon,+crypto",
]

# =============================================================================
# ANDROID ARMV7 OPTIMIZATION
# =============================================================================

[target.armv7-linux-androideabi]
rustflags = [
    # Size optimization
    "-C", "opt-level=z",
    # Note: LTO removed due to incompatibility with rlib builds (cargo-ndk builds all crate types)
    "-C", "codegen-units=1",
    "-C", "panic=abort",

    # Linker optimizations
    "-C", "link-arg=-Wl,--gc-sections",
    "-C", "link-arg=-Wl,--strip-all",
    "-C", "link-arg=-Wl,--hash-style=gnu",
    "-C", "link-arg=-Wl,--icf=all",
    "-C", "link-arg=-Wl,--exclude-libs,ALL",

    # Optimize for Cortex-A9 (older devices)
    "-C", "target-cpu=cortex-a9",

    # Enable NEON
    "-C", "target-feature=+neon",
]

# =============================================================================
# ANDROID X86_64 OPTIMIZATION
# =============================================================================

[target.x86_64-linux-android]
rustflags = [
    # Size optimization
    "-C", "opt-level=z",
    # Note: LTO removed due to incompatibility with rlib builds (cargo-ndk builds all crate types)
    "-C", "codegen-units=1",
    "-C", "panic=abort",

    # Linker optimizations
    "-C", "link-arg=-Wl,--gc-sections",
    "-C", "link-arg=-Wl,--strip-all",
    "-C", "link-arg=-Wl,--hash-style=gnu",
    "-C", "link-arg=-Wl,--icf=all",
    "-C", "link-arg=-Wl,--exclude-libs,ALL",

    # Target modern x86_64
    "-C", "target-cpu=x86-64",
]

# =============================================================================
# ANDROID X86 (32-bit) OPTIMIZATION
# =============================================================================

[target.i686-linux-android]
rustflags = [
    # Size optimization
    "-C", "opt-level=z",
    # Note: LTO removed due to incompatibility with rlib builds (cargo-ndk builds all crate types)
    "-C", "codegen-units=1",
    "-C", "panic=abort",

    # Linker optimizations
    "-C", "link-arg=-Wl,--gc-sections",
    "-C", "link-arg=-Wl,--strip-all",
    "-C", "link-arg=-Wl,--hash-style=gnu",
    "-C", "link-arg=-Wl,--icf=all",
    "-C", "link-arg=-Wl,--exclude-libs,ALL",
]

# =============================================================================
# LINUX OPTIMIZATION (for reference)
# =============================================================================

[target.x86_64-unknown-linux-gnu]
rustflags = [
    "-C", "link-arg=-Wl,--gc-sections",
    "-C", "link-arg=-Wl,--strip-all",
    "-C", "link-arg=-Wl,--as-needed",
]

# =============================================================================
# MACOS OPTIMIZATION (for reference)
# =============================================================================

[target.aarch64-apple-darwin]
rustflags = [
    "-C", "link-arg=-dead_strip",
    "-C", "target-cpu=apple-m1",
]

[target.x86_64-apple-darwin]
rustflags = [
    "-C", "link-arg=-dead_strip",
]

# =============================================================================
# NOTES
# =============================================================================
#
# Target CPU Options:
# - cortex-a53: Most Android phones (2015-2018)
# - cortex-a55: Mid-range devices (2018+)
# - cortex-a76: High-end devices (2019+)
# - cortex-x1: Flagship devices (2021+)
#
# To check available CPUs:
# rustc --print target-cpus --target aarch64-linux-android
#
# Expected size reduction: 65-70% (from 28MB to 8-10MB)
#
# Build command:
# cargo ndk -t arm64-v8a -p 21 -- build --release \
#     --no-default-features --features boringssl-vendored
