# è¿™æ˜¯ quiche/Cargo.toml çš„æ‰©å±•ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•æ·»åŠ  cpp-engine ç‰¹æ€§

[package]
name = "quiche"
version = "0.24.6"
authors = ["Alessandro Ghedini <alessandro@ghedini.me>"]
description = "ğŸ¥§ Savoury implementation of the QUIC transport protocol and HTTP/3"
build = "src/build.rs"
rust-version = "1.83"
edition = { workspace = true }
repository = { workspace = true }
license = { workspace = true }
readme = { workspace = true }
keywords = { workspace = true }
categories = { workspace = true }
include = [
  "/*.md",
  "/*.toml",
  "/COPYING",
  "/deps/boringssl/**/*.[chS]",
  "/deps/boringssl/**/*.asm",
  "/deps/boringssl/src/**/*.cc",
  "/deps/boringssl/**/CMakeLists.txt",
  "/deps/boringssl/**/sources.cmake",
  "/deps/boringssl/LICENSE",
  # â­ æ–°å¢ï¼šåŒ…å« C++ Engine æ–‡ä»¶
  "/api/**/*.h",
  "/api/**/*.cpp",
  "/api/CMakeLists.txt",
  "/examples",
  "/include",
  "/quiche.svg",
  "/src",
]

[features]
# ============================================================================
# ç°æœ‰ç‰¹æ€§ï¼ˆä¿æŒä¸å˜ï¼‰
# ============================================================================
default = ["boringssl-vendored", "http3"]

# Build the vendored BoringSSL library.
boringssl-vendored = []

# Use the BoringSSL library provided by the boring crate.
boringssl-boring-crate = ["boring", "foreign-types-shared"]

# Build quiche against OpenSSL instead of BoringSSL.
openssl = ["pkg-config"]

# Generate pkg-config metadata file for libquiche.
pkg-config-meta = []

# Replaces quiche's original congestion control
# implementation with one adapted from google/quiche.
gcongestion = []

# Equivalent to "--cfg fuzzing", but can also be checked in build.rs.
fuzzing = []

# Build and expose the FFI API.
ffi = ["dep:cdylib-link-lines"]

# Exposes internal APIs that have no stability guarantees across versions.
internal = []

# Enable HTTP/3 support (disable to reduce binary size by 30-40%).
http3 = []

# ============================================================================
# â­ æ–°å¢ç‰¹æ€§ï¼šC++ Engine
# ============================================================================

# Build C++ Engine with system libev
# ç”¨æ³•: cargo build --features cpp-engine
cpp-engine = []

# Build C++ Engine with vendored libev (æ¨èç»™æ— æ³•å®‰è£… libev çš„ç”¨æˆ·)
# ç”¨æ³•: cargo build --features cpp-engine-vendored
cpp-engine-vendored = ["cpp-engine"]

# å®Œæ•´ç‰¹æ€§ï¼ˆåŒ…æ‹¬æ‰€æœ‰åŠŸèƒ½ï¼‰
# ç”¨æ³•: cargo build --features full
full = ["http3", "qlog", "ffi", "cpp-engine"]

[package.metadata.release]
tag-prefix = ""

[package.metadata.docs.rs]
no-default-features = true
features = ["boringssl-boring-crate", "qlog"]
rustdoc-args = ["--cfg", "docsrs"]

[build-dependencies]
# ============================================================================
# ç°æœ‰æ„å»ºä¾èµ–ï¼ˆä¿æŒä¸å˜ï¼‰
# ============================================================================
cmake = "0.1"          # ç”¨äºæ„å»º BoringSSL
pkg-config = { version = "0.3", optional = true }
cdylib-link-lines = { version = "0.1", optional = true }

# ============================================================================
# â­ æ–°å¢æ„å»ºä¾èµ–ï¼šç”¨äºç¼–è¯‘ C++
# ============================================================================
cc = { version = "1.0", features = ["parallel"] }  # æ”¯æŒå¹¶è¡Œç¼–è¯‘

[dependencies]
# ============================================================================
# ç°æœ‰ä¾èµ–ï¼ˆä¿æŒä¸å˜ï¼‰
# ============================================================================
boring = { workspace = true, optional = true }
debug_panic = { version = "0.2.1" }
either = { version = "1.8", default-features = false }
foreign-types-shared = { version = "0.3.0", optional = true }
intrusive-collections = "0.9.5"
libc = { workspace = true }
libm = "0.2"
log = { workspace = true, features = ["std"] }
octets = { workspace = true, features = ["huffman_hpack"] }
qlog = { workspace = true, optional = true }
sfv = { version = "0.9", optional = true }
slab = "0.4"
smallvec = { workspace = true, features = ["union"] }
enum_dispatch = "0.3"

[target."cfg(windows)".dependencies]
windows-sys = { version = "0.59", features = [
  "Win32_Networking_WinSock",
  "Win32_Security_Cryptography",
] }

[dev-dependencies]
mio = { workspace = true, features = ["net", "os-poll"] }
ring = { workspace = true }
rstest = { workspace = true }
url = { workspace = true }

[lib]
crate-type = ["lib", "staticlib", "cdylib"]

# ============================================================================
# â­ æ–°å¢ï¼šç¤ºä¾‹é…ç½®ï¼ˆå±•ç¤ºå¦‚ä½•ä½¿ç”¨ C++ Engineï¼‰
# ============================================================================
[[example]]
name = "cpp_engine_demo"
required-features = ["cpp-engine"]

# ============================================================================
# æ„å»ºè¯´æ˜
# ============================================================================

# ä½¿ç”¨æ–¹æ³•ï¼š
#
# 1. åªæ„å»º Rust æ ¸å¿ƒï¼ˆé»˜è®¤ï¼‰
#    cargo build
#
# 2. æ„å»º Rust æ ¸å¿ƒ + C++ Engineï¼ˆéœ€è¦ç³»ç»Ÿæœ‰ libevï¼‰
#    cargo build --features cpp-engine
#
# 3. æ„å»º Rust æ ¸å¿ƒ + C++ Engine + vendored libev
#    cargo build --features cpp-engine-vendored
#
# 4. æ„å»ºæ‰€æœ‰åŠŸèƒ½
#    cargo build --features full
#
# 5. å‘å¸ƒæ¨¡å¼
#    cargo build --release --features cpp-engine
#
# 6. äº¤å‰ç¼–è¯‘ç¤ºä¾‹ï¼ˆAndroidï¼‰
#    export ANDROID_NDK_HOME=/path/to/ndk
#    cargo build --target aarch64-linux-android --features cpp-engine
#
# 7. äº¤å‰ç¼–è¯‘ç¤ºä¾‹ï¼ˆiOSï¼‰
#    cargo build --target aarch64-apple-ios --features cpp-engine

# ============================================================================
# ä¾èµ–è¯´æ˜
# ============================================================================

# cpp-engine ç‰¹æ€§éœ€è¦ä»¥ä¸‹å¤–éƒ¨ä¾èµ–ï¼š
#
# 1. C++17 ç¼–è¯‘å™¨
#    - GCC 7+ æˆ– Clang 5+ æˆ– MSVC 2019+
#
# 2. libev (å¦‚æœä¸ä½¿ç”¨ vendored)
#    Ubuntu/Debian:  sudo apt-get install libev-dev
#    macOS:          brew install libev
#    Fedora/RHEL:    sudo yum install libev-devel
#    Windows:        vcpkg install libev
#
# 3. å¹³å°ç‰¹å®šä¾èµ–
#    macOS/iOS:      Xcode Command Line Tools
#    Android:        Android NDK r19+
#    Windows:        Visual Studio 2019+

# ============================================================================
# æ€§èƒ½ä¼˜åŒ–æç¤º
# ============================================================================

# 1. ä½¿ç”¨å¹¶è¡Œæ„å»º
#    CARGO_BUILD_JOBS=8 cargo build --features cpp-engine
#
# 2. å¢é‡ç¼–è¯‘
#    cargo build --features cpp-engine  # é¦–æ¬¡æ„å»º
#    # ä¿®æ”¹ä»£ç ...
#    cargo build --features cpp-engine  # å¢é‡ç¼–è¯‘ï¼ˆåªç¼–è¯‘ä¿®æ”¹çš„æ–‡ä»¶ï¼‰
#
# 3. å‘å¸ƒä¼˜åŒ–
#    cargo build --release --features cpp-engine
#    # å¯ç”¨ LTO (Link-Time Optimization)
#    RUSTFLAGS="-C lto=fat" cargo build --release --features cpp-engine

# ============================================================================
# æ•…éšœæ’é™¤
# ============================================================================

# é—®é¢˜ 1: libev not found
# è§£å†³:
#   - å®‰è£… libev (è§ä¸Šé¢ä¾èµ–è¯´æ˜)
#   - æˆ–ä½¿ç”¨ vendored: cargo build --features cpp-engine-vendored
#   - æˆ–æ‰‹åŠ¨æŒ‡å®šè·¯å¾„: PKG_CONFIG_PATH=/custom/path cargo build
#
# é—®é¢˜ 2: C++17 compiler not found
# è§£å†³:
#   - å®‰è£…/å‡çº§ç¼–è¯‘å™¨ (GCC 7+, Clang 5+, MSVC 2019+)
#   - è®¾ç½®ç¼–è¯‘å™¨: CXX=/usr/bin/g++-9 cargo build
#
# é—®é¢˜ 3: Android NDK not found
# è§£å†³:
#   - è®¾ç½®ç¯å¢ƒå˜é‡: export ANDROID_NDK_HOME=/path/to/ndk
#
# é—®é¢˜ 4: é“¾æ¥é”™è¯¯ (undefined reference)
# è§£å†³:
#   - ç¡®ä¿ libev å®‰è£…æ­£ç¡®
#   - æ£€æŸ¥åº“è·¯å¾„: LD_LIBRARY_PATH=/usr/local/lib cargo build
#   - æ¸…ç†é‡å»º: cargo clean && cargo build

# ============================================================================
# CI/CD é…ç½®ç¤ºä¾‹
# ============================================================================

# GitHub Actions ç¤ºä¾‹ï¼š
#
# name: Build with C++ Engine
# on: [push, pull_request]
# jobs:
#   build:
#     runs-on: ${{ matrix.os }}
#     strategy:
#       matrix:
#         os: [ubuntu-latest, macos-latest]
#     steps:
#       - uses: actions/checkout@v3
#       - name: Install dependencies
#         run: |
#           if [ "$RUNNER_OS" == "Linux" ]; then
#             sudo apt-get update
#             sudo apt-get install -y libev-dev
#           elif [ "$RUNNER_OS" == "macOS" ]; then
#             brew install libev
#           fi
#       - name: Build
#         run: cargo build --features cpp-engine
#       - name: Test
#         run: cargo test --features cpp-engine
